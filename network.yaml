AWSTemplateFormatVersion: "2010-09-09"
Description: "Very simple Security Group"

Resources:
AWSTemplateFormatVersion: "2010-09-09"
Description: "Dual VPC IPSec lab with inline dynamic config (Helm-like values)."

Mappings:
  Values:
    Config:
      VPCAName: "VPCA"
      VPCBName: "VPCB"

      VPCACIDR: "10.0.0.0/16"
      VPCBCIDR: "192.168.0.0/16"

      VPCAEnableDnsHostnames: true
      VPCAEnableDnsSupport: true
      VPCBEnableDnsHostnames: false
      VPCBEnableDnsSupport: true

      DefaultTenancy: "default"
      DefaultTenancies: "default"

Resources:
  VPCA:
    Type: AWS::EC2::VPC
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
    Properties:
      CidrBlock: !FindInMap [Values, Config, VPCACIDR]
      EnableDnsSupport: !FindInMap [Values, Config, VPCAEnableDnsSupport]
      EnableDnsHostnames: !FindInMap [Values, Config, VPCAEnableDnsHostnames]
      InstanceTenancy: !FindInMap [Values, Config, DefaultTenancy]
      Tags:
        - Key: Name
          Value: !FindInMap [Values, Config, VPCAName]
        - Key: Environment
          Value: "Lab"

  VPCB:
    Type: AWS::EC2::VPC
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
    Properties:
      CidrBlock: !FindInMap [Values, Config, VPCBCIDR]
      EnableDnsSupport: !FindInMap [Values, Config, VPCBEnableDnsSupport]
      EnableDnsHostnames: !FindInMap [Values, Config, VPCBEnableDnsHostnames]
      InstanceTenancy: !FindInMap [Values, Config, DefaultTenancy]
      Tags:
        - Key: Name
          Value: !FindInMap [Values, Config, VPCBName]

  VPCASubnetA:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPCA
      CidrBlock: 10.0.0.0/24
      AvailabilityZone: "ap-southeast-1a"
      Tags:
      - Key: Name
        Value: VPCASubnetA

  VPCASubnetB:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPCA
      CidrBlock: 10.0.1.0/24
      AvailabilityZone: "ap-southeast-1b"
      Tags:
      - Key: Name
        Value: VPCASubnetB

  VPCBSubnetA:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPCB
      CidrBlock: 192.168.0.0/24
      AvailabilityZone: "ap-southeast-1a"
      Tags:
      - Key: Name
        Value: VPCBSubnetA

  VPCBSubnetB:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPCB
      CidrBlock: 192.168.1.0/24
      AvailabilityZone: "ap-southeast-1b"
      Tags:
      - Key: Name
        Value: VPCBSubnetB

  VPCPeeringConnection:
    Type: AWS::EC2::VPCPeeringConnection
    Properties:
      VpcId: !Ref VPCA
      PeerVpcId: !Ref VPCB
      Tags:
      - Key: Name
        Value: VPCPeeringConnection